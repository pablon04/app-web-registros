<div class="container-muestra">
  
  <div class="registrar">
    <h2>Registrar Nueva Muestra</h2>
    <form (ngSubmit)="agregarRegistro()">
      <input type="text" placeholder="Nº Muestra" id="numeroMuestra" [(ngModel)]="numeroMuestra" name="numeroMuestra" required>
      <input type="date" id="fecha" [(ngModel)]="fecha" name="fecha" required>
      <select name="palet" id="palet" [(ngModel)]="palet" required>
        <option value="" disabled selected>Seleccionar Palet</option>
        <option value="E-1">E-1</option>
        <option value="E-2">E-2</option>
        <option value="E-3">E-3</option>
        <option value="E-4">E-4</option>
        <option value="E-5">E-5</option>
        <option value="E-6">E-6</option>
        <option value="E-7">E-7</option>
        <option value="E-8">E-8</option>
        <option value="E-9">E-9</option>
        <option value="A-1">A-1</option>
        <option value="A-2">A-2</option>
        <option value="A-3">A-3</option>
        <option value="A-4">A-4</option>
        <option value="A-5">A-5</option>
      </select>

      <select name="ubicacionPalet" id="ubicacionPalet" [(ngModel)]="ubicacionPalet" required>
        <option value="" disabled selected>Seleccionar Ubicación Palet</option>
        <option value="Entrada">Entrada</option>
        <option value="Almacén">Almacén</option>
      </select>

      <textarea 
        placeholder="Observaciones (opcional)" 
        id="observaciones" 
        [(ngModel)]="observaciones" 
        name="observaciones"
        rows="2"
        class="textarea-observaciones">
      </textarea>

      <!-- <input type="text" placeholder="Palet" id="palet" [(ngModel)]="palet" name="palet" required> -->
      <!-- <input type="text" placeholder="Ubicación Palet" id="ubicacionPalet" [(ngModel)]="ubicacionPalet" name="ubicacionPalet" required> -->

      <button type="submit" class="agregar-btn">
        <i class="fa-solid fa-plus"></i>Agregar
      </button>
    </form>
  </div>

  <div class="registros">
    <h2>Registros de Muestras</h2>

    <div class="div_search">
      <input type="search" 
         [(ngModel)]="busquedanumeroMuestra" 
         name="busquedanumeroMuestra" 
         class="main__input"
         placeholder="Buscar Nº Muestra">

      <input type="date" 
         [(ngModel)]="busquedafecha" 
         name="busquedafecha" 
         class="main__input"
         placeholder="Buscar Fecha">


      <select name="busquedapalet" class="main__input" id="palet" [(ngModel)]="busquedapalet" required>
        <option value="" >Seleccionar Palet</option>
        <option value="E-1">E-1</option>
        <option value="E-2">E-2</option>
        <option value="E-3">E-3</option>
        <option value="E-4">E-4</option>
        <option value="E-5">E-5</option>
        <option value="E-6">E-6</option>
        <option value="E-7">E-7</option>
        <option value="E-8">E-8</option>
        <option value="E-9">E-9</option>
        <option value="A-1">A-1</option>
        <option value="A-2">A-2</option>
        <option value="A-3">A-3</option>
        <option value="A-4">A-4</option>
        <option value="A-5">A-5</option>
      </select>

      <select name="ubicacionPalet" class="main__input" id="ubicacionPalet" [(ngModel)]="busquedaubicacionPalet" required>
        <option value="">Seleccionar Ubicación Palet</option>
        <option value="Entrada">Entrada</option>
        <option value="Almacén">Almacén</option>
      </select>
      
      <div class="filtros-checkbox">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filtroSoloTirar" name="filtroSoloTirar">
          Tirar
        </label>
        
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filtroSoloAlmacenar" name="filtroSoloAlmacenar">
          Almacenar
        </label>
        
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="filtroSoloVencidos" name="filtroSoloVencidos">
          Más de 1 mes
        </label>
      </div>
      
    </div>
    <table>
      <tr>
        <th>Nº Muestra</th>
        <th>Fecha Entrada</th>
        <th>Palet</th>
        <th>Ubicación Palet</th>
        <th>Observaciones</th>
        <th>Tirar</th>
        <th>Almacenar</th>
        <th>Acciones</th>
      </tr>
    @for (registro of registrosFiltrados; track registro; let i = $index) {
      
      <tr class="main__text" [ngClass]="{
        'destacado-numeroMuestra': busquedanumeroMuestra && registro.numero_muestra.toLowerCase().includes(busquedanumeroMuestra.toLowerCase()),
        'destacado-fecha': busquedafecha && registro.fecha.toLowerCase().includes(busquedafecha.toLowerCase()),
        'destacado-palet': busquedapalet && registro.palet.toLowerCase().includes(busquedapalet.toLowerCase()),
        'destacado-ubicacionPalet': busquedaubicacionPalet && registro.ubicacion_palet.toLowerCase().includes(busquedaubicacionPalet.toLowerCase()),
        'fila-vencida': isDateOlderThanOneMonth(registro.fecha),
        'marcado-tirar': registro.tirar,
        'marcado-almacenar': registro.almacenar
        }">
        <td class="numeroMuestra">
          <ng-container *ngIf="!registro.editando">{{ registro.numero_muestra }}</ng-container>
          <input *ngIf="registro.editando" type="text" [(ngModel)]="registro.registroTemporal!.numero_muestra">
        </td>
        <td class="fecha">
          <ng-container *ngIf="!registro.editando">{{ registro.fecha }}</ng-container>
          <input *ngIf="registro.editando" type="date" [(ngModel)]="registro.registroTemporal!.fecha">
        </td>
        <td class="palet">
          <ng-container *ngIf="!registro.editando">{{ registro.palet }}</ng-container>
          <select *ngIf="registro.editando" [(ngModel)]="registro.registroTemporal!.palet">
            <option value="" disabled>Seleccionar Palet</option>
            <option value="E-1">E-1</option>
            <option value="E-2">E-2</option>
            <option value="E-3">E-3</option>
            <option value="E-4">E-4</option>
            <option value="E-5">E-5</option>
            <option value="E-6">E-6</option>
            <option value="E-7">E-7</option>
            <option value="E-8">E-8</option>
            <option value="E-9">E-9</option>
            <option value="A-1">A-1</option>
            <option value="A-2">A-2</option>
            <option value="A-3">A-3</option>
            <option value="A-4">A-4</option>
            <option value="A-5">A-5</option>
          </select>
        </td>
        <td class="ubicacionPalet">
          <ng-container *ngIf="!registro.editando">{{ registro.ubicacion_palet }}</ng-container>
          <select *ngIf="registro.editando" [(ngModel)]="registro.registroTemporal!.ubicacion_palet">
            <option value="" disabled>Seleccionar Ubicación Palet</option>
            <option value="Entrada">Entrada</option>
            <option value="Almacén">Almacén</option>
          </select>
        </td>
        <td class="observaciones">
          <ng-container *ngIf="!registro.editando">
            <span class="observaciones-texto">{{ registro.observaciones || '-' }}</span>
          </ng-container>
          <textarea *ngIf="registro.editando" 
                    [(ngModel)]="registro.registroTemporal!.observaciones" 
                    rows="2" 
                    class="textarea-edicion">
          </textarea>
        </td>
        <td class="tirar">
          <ng-container *ngIf="!registro.editando">
            <input type="checkbox" [checked]="registro.tirar" disabled>
          </ng-container>
          <input *ngIf="registro.editando" type="checkbox" [(ngModel)]="registro.registroTemporal!.tirar">
        </td>
        <td class="almacenar">
          <ng-container *ngIf="!registro.editando">
            <input type="checkbox" [checked]="registro.almacenar" disabled>
          </ng-container>
          <input *ngIf="registro.editando" type="checkbox" [(ngModel)]="registro.registroTemporal!.almacenar">
        </td>
        <td class="acciones">
          <button type="button" class="editar-btn" (click)="editarRegistro(registro)" *ngIf="!registro.editando">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" class="guardar-btn" (click)="guardarEdicion(registro)" *ngIf="registro.editando">
            <i class="fas fa-save"></i>
          </button>
          <button type="button" class="cancelar-btn" (click)="cancelarEdicion(registro)" *ngIf="registro.editando">
            <i class="fas fa-times"></i>
          </button>
          <button type="button" class="eliminar-btn" (click)="eliminarRegistro(registro)">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    }
      
    </table>

    <!-- Mostrar errores -->
    @if (error()) {
      <div class="error-message">
        Error: {{ error() }}
        <button (click)="limpiarError()">X</button>
      </div>
    }

    <!-- Mostrar loading -->
    @if (loading()) {
      <div class="loading">Cargando...</div>
    }

  </div>

</div>